name: CI-CD Pipeline

on:
  workflow_dispatch:     # ‚Üê enables Run Workflow button
  push:
    branches: [ "main" ]

env:
  JAR_NAME: datastore-0.0.7.jar
  SONAR_HOST_URL: "http://13.235.45.29:9000"
  SONAR_PROJECT_KEY: "myproject"
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Set up Maven Cache
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: maven-${{ hashFiles('**/pom.xml') }}

      - name: SonarQube Scan
        run: |
          mvn clean package -DskipTests=true sonar:sonar \
            -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_TOKEN}

      - name: Build Package
        run: mvn clean package -DskipTests=true

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: jar-file
          path: target/${{ env.JAR_NAME }}

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: jar-file
          path: .

      - name: Copy JAR to EC2
        run: |
          scp -o StrictHostKeyChecking=no \
            -i ${{ secrets.EC2_SSH_KEY }} \
            ${{ env.JAR_NAME }} \
            ec2-user@${{ secrets.EC2_IP }}:/home/ec2-user/

      - name: Deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no \
            -i ${{ secrets.EC2_SSH_KEY }} \
            ec2-user@${{ secrets.EC2_IP }} << 'EOF'

          PID=$(pgrep -f datastore-0.0.7.jar || true)
          if [ -n "$PID" ]; then
            sudo kill -9 $PID
          fi

          sudo mkdir -p /var/log/app
          sudo chmod 777 /var/log/app

          nohup java -jar /home/ec2-user/datastore-0.0.7.jar \
            --MYSQL_HOST="jdbc:mysql://database-1.cp4s0mqyo7x3.ap-south-1.rds.amazonaws.com:3306/datastore?createDatabaseIfNotExist=true" \
            --MYSQL_USERNAME="admin" \
            --MYSQL_PASSWORD="Cloud123" \
            --LOG_FILE_PATH="/var/log/app/datastore.log" \
            --server.port=8084 \
            > /var/log/app/nohup.out 2>&1 &

          EOF

